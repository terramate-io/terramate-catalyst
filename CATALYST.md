# Terramate Catalyst

> [!IMPORTANT]
> Terramate Catalyst Features like Scaffolding, Bundles, and Components are only available in Terramate CLI Catalyst.
> Terramate CLI Catalyst is free to use for small projects. See details on [terramate.io].

> [!TIP]
> Terramate Catalyst is currently only available for design partners. If you are interested in joining our design partner programm, please [contact us].

Terramate Catalyst helps developers to forget about infrastructure by leveraging Infrastructure as Code Blueprints designed by platform engineers and configuring them in a one-click experience.

Such blueprints are implemented as Terramate Components and instantiated through Terramate Bundles.

A Terramate Component defines what code shall be generated given a set of Component Inputs combined with Terramate Code Generation.

A Terramate Bundle defines what Terramate Stacks should be created and what Terramate Components shall be instantiated within those Terramate Stacks.

Terramate Catalyst will prompt users for important information only as defined by creators of a Terramate Bundle. After Scaffolding a Bundle Instantiation will be generated in a file (defined by the [Bundle Scaffolding Configuration]) containing the user inputs.

Terramate Code Generation will then create the Terramate Stacks (only if not already existing) and generate all IaC files within each Terramate Stack.

Terramate Catalyst can be mixed with normal Terramate Code Generation but code defined in Components will not inherit through the hierarchy by default.

# Important CLI Commands for catalyst

As a user you might just want to instantiate bundles, generate code, create a PR and forget about the rest.
The follwoing set of commands help you to do achieve this goal, given bundles are available within you repository.

## Command: `terramate scaffold`

`terramate scaffold` spwans a CLI based interface prompoting the caller for specific inputs.

Which inputs are actually prompted in the initial scaffolding is defined by the bundle author and can be reconfigured using [Bundle Definition Overrides](#bundle-definition-override) and [Bundle Definitions Extension](#bundle-definition-extension) if required.
By default the caller should not bother about such details and just run the scaffolding process.

After all inputs are provided, a `/path/to/{bundle}.tm.hcl` file will be created containing the [Bundle Instantiation](#bundle-instantiation) configuration. The files location and the bundle blocks label are defined via the [Bundle Scaffolding Configuration](#bundle-scaffolding-hcl-block).

The caller does not need to care about such details and should just run `terramate generate` next.

## Command: `terramate generate`

`terramate generate` when used with bundles will also take care of creating Terramate Stacks as configured in the [Bundle Definition](#bundle-definition).

Bundle Stacks will only be created if they do not already exist. When [Bundle Stacks] already exist, additional code will be generated within those stacks but no metadata or stack configuration will be changed.

This also includes keeping the stack configuration in place when a [Bundle Instantiation](#bundle-instantiation) is removed.

This allows to remove code generated by bundles from a stack without deleting the stack itself resulting in any Terraform/OpenTofu plan/apply to plan or execute the destruction of the removed resources.

Once all resources in a stack are destroyed, leaving the stack empty, `terramate stacks purge` can be called to remove the stack from the configuration.

## Comamnd: `terramate purge`

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

`terramate stack purge` removes stacks that do not have any active resources from code and archives them on Terramate Cloud. New stacks that are not yet synchronized to Terramate cloud will not be removed by default.

To know what resources are available in a stack a contineous Terramate Cloud synchronization (e.g. a daily drift check) needs to be configured to track the state of stacks.

## Command: `terramate bundles list`

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

## Command: `terramate components list`

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

# Bundles

Terramate Bundles define Terramate Stacks containing Terramate Components.

## Bundle Collections

Bundle Collection define what bundles and versions shall be available within a repository for users to reference and use.

This allows to present a focused view of available bundles and recommended version instead of overwhelming the caller with all availabel bundles in all availabke version.

### Local Collections

All local bundles are automatically picked up and will be available for `terramate scaffold` selection.

### Remote Collections

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

## Bundle Instantiation

A bundle can be instantiated in multiple ways.

This includes guiding the caller through a set of questions to answer and values to set via [Terramate Catalyst](#instantiation-via-terramate-scaffolding-hcl).

But bundles can also be instantiated by creating a configuration in [HCL](#bundle-instantiation-hcl-configuration-syntax) or in [YAML](#bundle-instantiation-yaml-configuration-syntax).

Creating such configurations can also be orchestrated using [Internal Developer Portals](#instantiation-via-developer-portals) or using AI aka [Vibe Coding](#instantiation-via-vibe-coding) that manage to create the configuration files and run the additional code generation commands.

### Instantiation via Terramate Catalyst (HCL)

When using Terramate CLI native scaffolding the instantiation of a bundle is as easy as
running the commands [`terramate scaffold`](#command-terramate-scaffold) followed by [`terramate generate`](#command-terramate-generate).

For details about those command see [above](#important-cli-commands-for-scaffolding).

Running `terramate scaffold` will guide the caller through a set of prompts.

First a Terramate Bundle to instantiate needs to be selected from either a Local Collection (local bundles within the repository) or a Remote Collection.

Afterwards the CLI UI will ask for values of a set of input variables.

What variables will be asked for is defined within the bundle. For all inputs that are not asked for, defaults will be applied.

### Instantiation in editors via Language Server Features

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.


### Instantiation via Developer Portals

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

### Instantiation via Vibe Coding

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

### Bundle Instantiation HCL Configuration Syntax

```hcl
# file: bundle.tm.hcl or bundle.tm
bundle "{name}" {
	source  = "{bundle-source}"
	version = "{bundle-version}" # not yet supported

	inputs {
		attribute = value
	}
}
```

- The `{name}` must (be a slug):
  - contain no more than 255 ASCII characters
  - contain only lowercase alphanumeric characters or '-'
  - start with an alpha `[a-z]` character
  - end with an alphanumeric `[a-z0-9]` character
- The `{bundle-source}` must be either:
  - a local directory that is relative to the file containing the bundle instantiation
  - a local directory that is absolute to the repositories root local directory
	- a remote source reference
- The `{bundle-version}` can be:
  - a pinned version (not yet supported)
	- a version contraint (not yet supported)

#### Supported attributes and blocks

- `bundle` (Block) A bundle block to instantiate a bundle. The block expects one label `{name}` naming the instantiation. This label needs to be unique within the directory the bundle was instantiated in.

  - `bundle.{name}.source` (Attribute) (Required) The location of the bundle definition

  - `bundle.{name}.version` (Attribute) (Optional) The version of the bundle definition

  - `bundle.{name}.inputs` (Attribute) A map of inputs.
	  This map can contain any keys. Only keys matching available inputs are considered. Keys not matching available inputs are ignored.

  - `bundle.{name}.inputs` (Block) A block of inputs.
		Each key must be a valid and existing input in the bundle definition.
		An input defined in this block takes precedence over an input by the same name defined in the inputs map via the `bundle.{name}.inputs` attribute.

### Bundle Instantiation YAML Configuration Syntax

```
# file: bundle.tm.yml or bundle.tm.yaml
apiVersion: terramate.io/cli/v1
kind: BundleInstance
metadata:
	name: {name}
spec:
	source: {bundle-source}
	inputs:
	  attribute: value
```

This YAML variant is the equivalent to the HCL variant above.

To transform HCL to YAML the following details are important:

- In YAML the instantiation of a bundle is identified by the `BundleInstantiation` kind.
- The `metadata.name` field represents the HCL label on the HCL `bundle {}` block.
- The `spec` contains the same attributes as the body of the HCL `bundle {}` block.
- Values in an attribute within `spec.inputs` support HCL expressions using `!hcl {expression}` syntax in the value part.

#### Supported attributes

- `apiVersion` (Required) needs to be `terramate.io/cli/v1`
- `kind` (Required) needs to be BundleInstance
- `metadata` (Required) A map of metadata required to configure this bundles instantance
	- `metadata.name` (Required) a unique name of the bundle. It needs to be unique within the directory the bundle is instantiated in.
	- `metadata.uuid` (Optional) an UUID to identify the bundle instantiation. (not yet available)
- `spec` (Required)
  - `spec.source` (Required) The location of the bundle definition
	- `spec.version` (Required) The version of the bundle definition
	- `spec.inputs` (Required) A map of inputs. Each key must be a valid and existing input in the bundle definition.

## Bundle Reconfiguration

### Reconfiguration via Terramate Catalyst

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

### Reconfiguration via Developer Portals

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

### Reconfiguration via Vibe Coding

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

### Reconfiguration via the editor tool of choice

To reconfigure a bundle instance you need to manipulate the HCL or YAML code and run `terramate generate` after saving the changes.

This can be done with any code editor or using tools like `sed`.

## Bundle Definition

The Bundle Definition describes how a bundle can be used and provides the schema used in Bundle Instantiations.
It also provides information about data required at scaffolding or reconfiguration time.

- Bundle Metadata - Information about the bundle including name, description, and version.
- Bundle Alias - An alias to reference the instance of a bundle.
- Bundle Inputs - a set of input variables that are available to be set during Bundle Instantiation.
- Bundle Stacks - zero or more stacks that the bundle should create (if they do not already exist) or maintain.
- Bundle Stack Component Instantiations - Terramate Components to be instantiatied within Bundle Stacks that define how to generate actual code.
- Bundle Scaffolding configuration - Defines where a bundle instantiation shall be created within the hierarchy of the repository.

A Bundle Definition does not define any code or code generation directly but only through Terramate Components.

### Bundle Definition HCL Configuration Syntax

A Terramate Bundle is defined using a `define bundle {}` block.

A single diretory can only define a single bundle.

The `define` keyword does not only help to differentiate between a [Bundle Instantiation](#bundle-instantiation) and a Bundle Definition, but also allows for [Bundle Overrides](#bundle-definition-override) using `override bundle {}` blocks and [Bundle Extensions](#bundle-definition-extension) using `extend bundle {}` blocks.

Each Terramate Bundle Definition should include [metadata](#bundle-metadata-hcl-block), a [scaffodling configuration](#bundle-scaffolding-hcl-block), [inputs](#bundle-input-hcl-block), [exports](#bundle-export-hcl-block), [stacks](#bundle-stacks-hcl-block), and [components in stacks](#components-in-stacks).

All definitions for a bundle will be merged, so it ins not required to define everthing within the same `define bundle {}` block. Short syntax for block references can be used as in `define bundle metadata {}` instead of

```hcl
define bundle {
	metadata {
		# ...
	}

	input "name" {
	}
}
```

#### Bundle Metadata HCL Block

Example of bundle metdadata:

```hcl
define bundle metadata {
	class   = "example.com/my-bundle"
	version = "1.0.0"
	name    = "My Bundle"
	description = <<-EOF
		My first Terramate Bundle is doing great things
	EOF

}
```

#### Bundle Alias HCL Attribute

The `alias` of a bundle can be used for easy access to a bundle instatiation of a given class.

The `alias` will be calculated for each bundle instance and needs to be unique within the repository and within the same `class`.
It can be a combination of various bundle inputs but need to be of type `string`.

Terramate Functions are available.

It is recommended to generate a slug out of the inputs to guarantee uniqueness.

```
define bundle {
  alias = tm_slug(bundle.input.name.value)
}
```

The default for `alias` is directory where the bundle is instantiated and the `name` used in scaffolding or defined within the bundle instance metadata: `{bundle-isntance-dirname}:{name}`.


#### Bundle Input HCL Block

Example of bundle inputs:

```hcl
define bundle {
	input "name" {
		type        = string
		prompt      = "Name of the Service"
		description = "Set a name for the serivce"
	}

	input "visibility" {
		type        = string
		prompt      = "Visibility"
		description = "Visibility of the Resource"
		allowed_values = [
			{ name = "A public resource", value = "public" },
			{ name = "A private resource", value =  "private" },
		]
		default = "private"
	}
}
```

#### Bundle Scaffolding HCL Block

Example of bundle scaffolding configuration

```hcl
define bundle scaffolding {
	path = "/path/to/bundle_${tm_slug(bundle.input.name.value)}.tm.yml"
	name = tm_slug(bundle.input.name.value)
}
```

When using `terramate scaffold` command, this configuration defined where the bundle instantiation YAML will be generated and how it will ne named

#### Bundle Stacks HCL Block

- Each Bundle can define any number of Bundle Stacks. This includes allwoing to define zero stacks if a bundle should just be used for configuration sharing.
- Each Bundle Stack can instantiate any number of components.
- If a stack already exists, the stack metadata is not updated. Note: In future versions, the metdata will be inherited to the stack without hardcoding it on instantiation.
- If a bundle instantiation is removed from code, the Bundle Stacks will NOT be removed too - only generated HCL code or generated files will be removed from the stack.


The following code shows a Catalyst Bundle Stack instantiating one Catalyst Component, forwarding all bundle inputs as component inputs. In addition stack metadata defines `name`, `description`, and `tags` for the new stack that will be create relativ to the bundle in the location defined by `path`

```hcl
define bundle stack "organization-members" {
	metadata {
		path = "organization/memberships"

		name        = "GitHub Orgnaitzaion Member"
		description = "GitHub organization members, owners, collaborators and blocked users"

		tags = [
			"example.com/github-organization",
		]
	}

	component "members" {
		source = "/components/terramate.io/terramate-tf-github-organization-members/v1"
		inputs = { for k in tm_keys(bundle.input) : k => bundle.input[k].value }
	}
}
```


##### Stack metadata

The following metadata is supported in Bundle Stacks: `name`, `description`, `tags`, `after`, `before`, `wants`, `wanted_by`.
Those match the metdata supported by Terramate CLI in the `stack {}` block.

To define the metadata, `bundle.input` and Terramate Functions are available to template the resulting values.

It is recommended to prefix tags with the maintainer domain name e.g. `example.com/my-tag` instead of `my-tag` to not conflict with user defined tags.

Additionally `path` defines where the stack will be created
	- when relativ: relativ to the file containing the bundle instantiation
	- when absolute: absolute to the repository root

##### Components in Stacks

Any [Component Instantiation](#component-instantiation-hcl-configuration-syntax) can be used inside `define bundle stack "label" {}` blocks

#### Bundle Export HCL Block

A Bundle can define exports. Those are meant to pass pre computed configuration to other bundles or code generation.

They can be used to generate allowed_values for scaffolding purposes or to share pre calculated structures to share information about resources the bundle created.


The follwoing example defines a `team_tuple` that exports a tuple of two input variables: `parent` and `name`.

```hcl
define bundle export "team_tuple" {
	value = [bundle.input.parent.value, bundle.input.name.value]
}
```

### Bundle Definition Override

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

### Bundle Definition Extension

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

# Components HCL Configuration Syntax

The next sections define the HCL syntax on how to instantiate and define components.

## Component Instantiation HCL Configuration Syntax

```hcl
component "members" {
	source = "/components/terramate.io/terramate-tf-github-organization-members/v1"
	inputs = { for k in tm_keys(bundle.input) : k => bundle.input[k].value }
}
```

## Component Definition HCL Configuration Syntax

A Terramate Catalyst Component is defined using a `define component {}` block.

A single diretory can only define a single component.

The `define` keyword helps to differentiate between a [Component Instantiation](#component-instantiation) and a Component Definition.

Each Terramate Component Definition should include [metadata](#component-metadata-hcl-block), [inputs](#bundle-input-hcl-block).

All definitions for a component will be merged, so it ins not required to define everthing within the same `define component {}` block. Short syntax for block references can be used as in `define component metadata {}` instead of

```hcl
define component {
	metadata {
		# ...
	}

	input "name" {
	}
}
```

### Component Metadata HCL Block

Example of component metdadata:

```hcl
define component metadata {
	class   = "example.com/my-component"
	version = "1.0.0"
	name    = "My Component"
	description = <<-EOF
		My first Terramate Component is doing amazing stuff
	EOF
}
```

### Component Inputs HCL Block

Example of component inputs:

```hcl
define component {
	input "name" {
		type        = string
		prompt      = "Name of the Service"
		description = "Set a name for the serivce"
	}

	input "visibility" {
		type        = string
		prompt      = "Visibility"
		description = "Visibility of the Resource"
		allowed_values = [
			{ name = "A public resource", value = "public" },
			{ name = "A private resource", value =  "private" },
		]
		default = "private"
	}
}
```

### Component Code Generation

To define the code a component generates all Terramate configuration within the same directory is considered. It is possible to use `generate_hcl` and `generate_file` blocks or use `.tmgen` shortcuts to define code generation.

`component.input` is available within the code generation to reference inputs.

The value of the following input `name` can be accessed as `component.input.name.value` within code generation definition.

`bundle.input` is not available an needs to be passed down via component inputs.

```hcl
define component input "name" {
	type        = string
	prompt      = "Name of the Service"
	description = "Set a name for the serivce"
}
```

# Catalyst Variables in the `terramate` namespace

The `terramate` namse space is extended with information about all instantiated bundles.

Note: the new variables are NOT YET available everywhere, but the availability will be extended in future versions.

## terramate.bundles

`terramate.bundles` is a map of maps keyed by `class` and `alias` of a bundle. to access inputs of a specific bundle the syntax is `terramate.bundles[{class}][{alias}].inputs`. The exports are available as `terramate.bundles[{class}][{alias}].exports`.

A specific inputs value of a bundle of class `example.com/my-bundle/v1` having the `alias` of `my-alias` can be accessed by `terramate.bundles[example.com/my-bundle/v1][my-alias].inputs.name.value`.

Terramate functions and HCL constructs can be used to loop through the information with any level of complexity:

```hcl
allowed_values = tm_concat(
	[{ name = "-- None --", value = null }],

	# create a list of Parent Teams from exported configuration values of the GitHub Team Bundle
	[for parent in tm_try(
		tm_joinlist("/",
			tm_tree(tm_values(
				terramate.bundles["terramate.io/tf-github-team"])[*].exports.team_tuple.value
			)
		),
		[]) :
		{ name = parent, value = tm_reverse(tm_split("/", parent))[0] }
	]
)
```

This example builds a tree of teams, formats the hierachy and maps it to values that can be used as inputs to define a parent of a team.

## terramate.components

> [!NOTE]
> This feature is not yet available in public preview. Please [schedule a demo] if you are intersted in more details or want to join our design partner program.

# Upcoming features available as preview

## Convert a Terraform/Opentofu module to a Terramate Component

`terramate component create` can be used inside of a terraform module directory to create a simple templated component that converts all TF module variables to component inputs and defines an intial metdata configuration for the component.


[terramate.io]: https://terramate.io
[contact us]: https://terramate.io/demo
[schedule a demo]: https://terramate.io/demo